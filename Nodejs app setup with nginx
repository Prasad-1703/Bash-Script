#!/bin/bash
set -e

APP_NAME="nodeapp"
APP_DIR="/var/www/$APP_NAME"
SERVICE_FILE="/etc/systemd/system/$APP_NAME.service"
NGINX_CONF="/etc/nginx/sites-available/$APP_NAME"
REPO_URL="https://github.com/Prasad-1703/Nodejs-bash-script.git"
APP_USER="nodeuser"

# --- Step 1: Ensure non-root user exists ---
if ! id "$APP_USER" &>/dev/null; then
    echo "[INFO] Creating user $APP_USER"
    sudo useradd -r -s /bin/false "$APP_USER"
fi

# --- Step 2: Ask for GitHub PAT ---
read -s -p "Enter your GitHub Personal Access Token (PAT): " GITHUB_PAT
echo
CLONE_URL="https://${GITHUB_PAT}@github.com/Prasad-1703/Nodejs-bash-script.git"

# --- Step 3: Remove previous folder if exists ---
if [ -d "$APP_DIR" ]; then
    sudo rm -rf "$APP_DIR"
fi

# --- Step 4: Clone repo (5 attempts) ---
for i in {1..5}; do
    echo "[INFO] Attempt $i: Cloning repo..."
    if git clone "$CLONE_URL" "$APP_DIR"; then
        echo "[SUCCESS] Repo cloned successfully."
        break
    else
        echo "[ERROR] Clone failed. Retrying..."
        sudo rm -rf "$APP_DIR"
        sleep 3
    fi
    if [ "$i" -eq 5 ]; then
        echo "[FATAL] Failed to clone repo after 5 attempts. Exiting."
        exit 1
    fi
done

# --- Step 5: Install Node.js if missing ---
if ! command -v node &>/dev/null; then
    echo "[INFO] Installing Node.js..."
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    sudo apt-get install -y nodejs
fi

# --- Step 6: Install Nginx if missing ---
if ! command -v nginx &>/dev/null; then
    echo "[INFO] Installing Nginx..."
    sudo apt-get install -y nginx
fi

# --- Step 7: Fix permissions ---
sudo chown -R "$APP_USER":"$APP_USER" "$APP_DIR"

# --- Step 8: Clean npm cache and install dependencies ---
cd "$APP_DIR"
sudo -u "$APP_USER" rm -rf "$APP_DIR/.npm_cache"
sudo -u "$APP_USER" npm install --prefix "$APP_DIR" --cache "$APP_DIR/.npm_cache" --production

# --- Step 9: Create systemd service file ---
sudo tee "$SERVICE_FILE" >/dev/null <<EOF
[Unit]
Description=Node.js App Service
After=network.target

[Service]
User=$APP_USER
WorkingDirectory=$APP_DIR
ExecStart=/usr/bin/node $APP_DIR/server.js
Restart=always
RestartSec=5
CPUQuota=50%
MemoryMax=256M
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd, enable and start service
sudo systemctl daemon-reload
sudo systemctl enable "$APP_NAME"
sudo systemctl restart "$APP_NAME"
echo "[INFO] Service $APP_NAME started successfully"

# --- Step 10: Create Nginx reverse proxy ---
sudo tee "$NGINX_CONF" >/dev/null <<EOF
server {
    listen 80;
    server_name _;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOF

# --- Step 11: Disable default Nginx page ---
if [ -f /etc/nginx/sites-enabled/default ]; then
    sudo unlink /etc/nginx/sites-enabled/default
fi

# Enable site & reload nginx
sudo ln -sf "$NGINX_CONF" /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx

echo "[SUCCESS] Deployment complete! App is running at http://your-server-ip/"
